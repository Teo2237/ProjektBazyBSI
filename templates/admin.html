<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='/workspaces/static/css/main.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ®</text></svg>">
    <title>Panel Administracyjny</title>
    <style>
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        form input, form textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        form button { padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        form button:hover { background-color: #0056b3; }
        ul { list-style-type: none; padding: 0; }
        li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        li:last-child { border-bottom: none; }
        .buttons button { margin-left: 10px; padding: 5px 10px; cursor: pointer; }
        .edit-btn { background-color: #ffc107; }
        .delete-btn { background-color: #dc3545; color: white; }
        #edit-form-container { display: none; margin-top: 20px; }
    </style>
</head>
<body>
{% include '_header.html' %}
<main class="container">
        <div class="container">
            <h1>Panel Administracyjny</h1>

            <section id="add-form-container">
                <h2>Dodaj nowÄ… grÄ™</h2>
                <form id="add-game-form">
                    <input type="text" name="title" placeholder="TytuÅ‚" required>
                    <input type="date" name="release_date" required>
                    <input type="text" name="genres" placeholder="Gatunki (oddzielone przecinkami)">
                    <input type="text" name="developer" placeholder="Deweloper">
                    <input type="text" name="publisher" placeholder="Wydawca">
                    <input type="url" name="cover_image" placeholder="URL do okÅ‚adki">
                    <textarea name="description" placeholder="Opis"></textarea>
                    <button type="submit">Dodaj grÄ™</button>
                </form>
            </section>

            <section>
                <h2>ZarzÄ…dzaj grami</h2>
                <ul id="admin-games-list">
                    </ul>
            </section>

            <section id="edit-form-container">
                <h2>Edytuj grÄ™</h2>
                <form id="edit-game-form">
                    <input type="hidden" name="id">
                    <input type="text" name="title" placeholder="TytuÅ‚" required>
                    <input type="date" name="release_date" required>
                    <input type="text" name="genres" placeholder="Gatunki (oddzielone przecinkami)">
                    <input type="text" name="developer" placeholder="Deweloper">
                    <input type="text" name="publisher" placeholder="Wydawca">
                    <input type="url" name="cover_image" placeholder="URL do okÅ‚adki">
                    <textarea name="description" placeholder="Opis"></textarea>
                    <button type="submit">Zapisz zmiany</button>
                    <button type="button" id="cancel-edit">Anuluj</button>
                </form>
            </section>

        </div>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addForm = document.getElementById('add-game-form');
            const editFormContainer = document.getElementById('edit-form-container');
            const editForm = document.getElementById('edit-game-form');
            const gamesList = document.getElementById('admin-games-list');
            const cancelEditBtn = document.getElementById('cancel-edit');

            const API_URL = '/api/admin/games';

            // Konwertuje dane z formularza na obiekt JSON
            const getFormData = (form) => {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => { data[key] = value; });
                // PrzeksztaÅ‚ca string z gatunkami na tablicÄ™
                if (data.genres) {
                    data.genres = data.genres.split(',').map(g => g.trim());
                } else {
                    data.genres = [];
                }
                return data;
            };

            // Pobiera i wyÅ›wietla listÄ™ gier
            const fetchAndDisplayGames = async () => {
                try {
                    const response = await fetch('/api/games');
                    const games = await response.json();
                    gamesList.innerHTML = '';
                    games.forEach(game => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${game.title}</span>
                            <div class="buttons">
                                <button class="edit-btn" data-id="${game._id}">Edytuj</button>
                                <button class="delete-btn" data-id="${game._id}">UsuÅ„</button>
                            </div>
                        `;
                        gamesList.appendChild(li);
                    });
                } catch (error) {
                    console.error('BÅ‚Ä…d podczas pobierania gier:', error);
                }
            };

            // ObsÅ‚uga dodawania nowej gry
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = getFormData(addForm);
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    if (response.ok) {
                        addForm.reset();
                        fetchAndDisplayGames();
                    } else {
                        alert('Nie udaÅ‚o siÄ™ dodaÄ‡ gry.');
                    }
                } catch (error) {
                    console.error('BÅ‚Ä…d:', error);
                }
            });

            // ObsÅ‚uga klikniÄ™Ä‡ na liÅ›cie (Edytuj/UsuÅ„)
            gamesList.addEventListener('click', async (e) => {
                const gameId = e.target.dataset.id;
                if (!gameId) return;

                // Usuwanie gry
                if (e.target.classList.contains('delete-btn')) {
                    if (confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ grÄ™?')) {
                        try {
                            const response = await fetch(`${API_URL}/${gameId}`, { method: 'DELETE' });
                            if (response.ok) {
                                fetchAndDisplayGames();
                            } else {
                                alert('Nie udaÅ‚o siÄ™ usunÄ…Ä‡ gry.');
                            }
                        } catch (error) {
                            console.error('BÅ‚Ä…d:', error);
                        }
                    }
                }

                // Edycja gry
                if (e.target.classList.contains('edit-btn')) {
                    const response = await fetch(`/api/games/${gameId}`);
                    const game = await response.json();
                    
                    // WypeÅ‚nij formularz edycji
                    editForm.elements.id.value = game._id;
                    editForm.elements.title.value = game.title;
                    editForm.elements.release_date.value = game.release_date;
                    editForm.elements.genres.value = game.genres.join(', ');
                    editForm.elements.developer.value = game.developer || '';
                    editForm.elements.publisher.value = game.publisher || '';
                    editForm.elements.cover_image.value = game.cover_image || '';
                    editForm.elements.description.value = game.description || '';

                    editFormContainer.style.display = 'block';
                    addForm.style.display = 'none'; // Ukryj formularz dodawania
                }
            });

            // ObsÅ‚uga zapisu zmian w formularzu edycji
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = getFormData(editForm);
                const gameId = data.id;
                delete data.id; // Usuwamy ID z ciaÅ‚a zapytania
                
                try {
                    const response = await fetch(`${API_URL}/${gameId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        editFormContainer.style.display = 'none';
                        addForm.style.display = 'flex';
                        fetchAndDisplayGames();
                    } else {
                        alert('Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ gry.');
                    }
                } catch (error) {
                    console.error('BÅ‚Ä…d:', error);
                }
            });
            
            // Anulowanie edycji
            cancelEditBtn.addEventListener('click', () => {
                editFormContainer.style.display = 'none';
                addForm.style.display = 'flex';
            });

            // PoczÄ…tkowe zaÅ‚adowanie listy gier
            fetchAndDisplayGames();
        });
        </script>
    </main>
    {% include '_footer.html' %} 
</body>
</html>